@model LibraryDomain.Model.ReadingList

<h2>@Model.Title</h2>

<div>
    <input id="themeInput" placeholder="Add theme..." class="form-control" />
    <button id="addThemeBtn" class="btn btn-success mt-2">Add Theme</button>
</div>

@foreach (var theme in Model.Themes)
{
    <h3>@theme.Name</h3>

    <div>
        <input class="newItemInput" data-theme="@theme.Id" placeholder="Add item..." />
        <button class="addItemBtn btn btn-primary" data-theme="@theme.Id">Add</button>
    </div>

    <ul>
        @foreach (var item in theme.Items)
        {
            <li data-id="@item.Id">
                <input type="checkbox" @(item.IsDone ? "checked" : "") class="chk" />
                @item.Text
                <button class="del btn btn-danger btn-sm">X</button>
            </li>
        }
    </ul>
}

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>

    <script>
        const listId = @Model.Id;

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/readingListHub")
            .build();

        connection.on("ListUpdated", () => location.reload());

        connection.start().then(function () {
            connection.invoke("SyncList", listId);
        });
                document.getElementById("addThemeBtn").onclick = function () {
            const title = document.getElementById("themeInput").value;

            fetch(`/api/readinglists/${listId}/themes`, {
                method: "POST",
                body: JSON.stringify({ title }),
                headers: { "Content-Type": "application/json" }
            }).then(r => {
                if (r.ok) {
                    location.reload();
                    connection.invoke("UpdateList", listId);
                }
            });
        };
                document.querySelectorAll(".addItemBtn").forEach(btn => {
            btn.onclick = function () {
                const themeId = this.dataset.theme;
                const input = document.querySelector(`.newItemInput[data-theme="${themeId}"]`);
                const text = input.value;

                fetch(`/api/readinglists/themes/${themeId}/items`, {
                    method: "POST",
                    body: JSON.stringify({ text }),
                    headers: { "Content-Type": "application/json" }
                }).then(r => {
                    if (r.ok) {
                        location.reload();
                        connection.invoke("UpdateList", listId);
                    }
                });
            };
        });

        document.querySelectorAll(".chk").forEach(chk => {
            chk.onchange = function () {
                const id = this.parentElement.getAttribute("data-id");
                fetch(`/api/readinglists/items/${id}/toggle`, { method: "PUT" })
                    .then(() => connection.invoke("UpdateList", listId));
            };
        });

        document.querySelectorAll(".del").forEach(btn => {
            btn.onclick = function () {
                const id = this.parentElement.getAttribute("data-id");
                fetch(`/api/readinglists/items/${id}`, { method: "DELETE" })
                    .then(() => connection.invoke("UpdateList", listId));
            };
        });
    </script>
}
