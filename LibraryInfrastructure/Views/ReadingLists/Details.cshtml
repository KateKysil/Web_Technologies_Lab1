@model LibraryDomain.Model.ReadingList

<h2>@Model.Title</h2>

<div>
    <input id="newItemInput" placeholder="Add book..." class="form-control" />
    <button id="addBtn" class="btn btn-primary mt-2">Add</button>
</div>

<ul id="itemsList" class="mt-3">
    @foreach (var item in Model.Items)
    {
        <li data-id="@item.Id">
            <input type="checkbox" @(item.IsDone ? "checked" : "") class="chk" />
            @item.Text
            <button class="del btn btn-danger btn-sm">X</button>
        </li>
    }
</ul>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>

    <script>
        const listId = @Model.Id;

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/readingListHub")
            .build();

        connection.on("ListUpdated", () => location.reload());

        connection.start().then(function () {
            connection.invoke("SyncList", listId);
        });

        document.getElementById("addBtn").onclick = function () {
            const text = document.getElementById("newItemInput").value;
            fetch(`/api/readinglists/${listId}/items`, {
                method: "POST",
                body: JSON.stringify({ text }),
                headers: { "Content-Type": "application/json" }
            }).then(() => connection.invoke("UpdateList", listId));
        };

        document.querySelectorAll(".chk").forEach(chk => {
            chk.onchange = function () {
                const id = this.parentElement.getAttribute("data-id");
                fetch(`/api/readinglists/items/${id}/toggle`, { method: "PUT" })
                    .then(() => connection.invoke("UpdateList", listId));
            };
        });

        document.querySelectorAll(".del").forEach(btn => {
            btn.onclick = function () {
                const id = this.parentElement.getAttribute("data-id");
                fetch(`/api/readinglists/items/${id}`, { method: "DELETE" })
                    .then(() => connection.invoke("UpdateList", listId));
            };
        });
    </script>
}
